name: CI

on:
  pull_request:

permissions:
  contents: read

jobs:
  backend-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install backend dependencies
        working-directory: packages/backend
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pytest
        working-directory: packages/backend
        run: pytest -q

  frontend-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Typecheck web workspace
        run: npm run typecheck --workspace @vaultguard/web

      - name: Run web Vitest
        run: npm run test --workspace @vaultguard/web

  dependency-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: vaultguard
          path: .
          format: 'HTML'
          out: reports
          args: >-
            --scan package-lock.json
            --scan packages/backend/pyproject.toml
            --failOnCVSS 7

      - name: Upload Dependency-Check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports

  sast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep==1.107.0

      - name: Run Semgrep (OWASP ruleset)
        run: semgrep scan --config p/owasp-top-ten --error .
